title: NGSPICE.js - преобразование напряжения в скважность
category: Embedded 
tags: gEDA, ngspice, ОУ, ШИМ

[Продолжаем]({filename}../2016-10-28-ngspice-introduction/2016-10-28-ngspice-introduction.md) осваивать NGSPICE вообще и [ОУ]({filename}../2016-11-18-op-amp-basics/2016-11-18-op-amp-basics.md) в частности.

Для периодических прямоугольных импульсов можно выделить три главных параметра: амплитуда, частота и т.н. **коэффициент заполнения** (duty cycle) - некая безразмерная физическая величина равная отношению длительности импульса к его периоду. **Скважность** характеризует то же самое свойство, что и коэффициент заполнения, просто это обратная величина ```S = 1/D```, где S - скважность, D - коэффициент заполнения от 0 до 100%. Если длина импульса равна половине периода, то такой симметричный сигнал называется меандром. Чем больше коэффициент заполнения, тем большая *средняя* мощность передаётся от источника к нагрузке и так вплоть до 100% (постоянное напряжение на нагрузке). Поскольку цепь работает по принципу включён/выключен, то отсутствуют потери при передаче энергии и в результате управляя скважностью можно регулировать мощность на нагрузке от 0 до 100% с очень высоким коэффициентом  полезного действия (КПД). Говоря более формальным языком мы имеем дело с широтно-импульсной модуляцией (ШИМ, англ. pulse-width modulation (PWM)) - процессом управления мощностью, подводимой к нагрузке, путём изменения скважности импульсов при постоянной частоте.

<!-- 
<a href="{attach}LT1007CS.txt"></a>
-->

В следующих схемах использовалась SPICE модель операционного усилителя LT1007:

    :::bash
    ~$ wget http://cds.linear.com/docs/en/software-and-simulation/LT1007CS.txt

[линейный преобразователь напряжение - скважность]({attach}comparator-single.sch) | [netlist]({attach}comparator-single.net) | [ngspice.js](https://ngspice.js.org/?gist=9a661744aef8b6f491f7664f18f79a51)

![screenshot]({attach}show-img-comparator-single.png){:style="width:100%; border:1px solid #ddd;"}

    :::text
    ngspice 1 -> source comparator-single.net
    ngspice 2 -> tran 10m 4
    ngspice 3 -> plot v(out) v(triangle)

В основе лежет очень простая идея - сигнал с генератора треугольных импульсов поступает на вход [компаратора]({filename}../2016-11-24-op-amp-schmitt/2016-11-24-op-amp-schmitt.md). Задавая опорное напряжение компаратора нарезаются *подобные треугольники* (углы равны). Как мы знаем (да да) из школьного курса по геометрии подобные треугольники характеризуются *коэффициентом подобия*  k, равным отношению сходственных сторон. При этом отношение длин  высот также равно коэффициенту подобия. В нашем случае высота это опорное напряжение компаратора, она опущена на сторону треугольника, которая является периодом следования треугольных импульсов. В итоге имеем *линейную зависимость* скважности от опорного напряжения на компараторе !

![screenshot]({attach}comparator-single-canvas.png){:style="width:100%; border:1px solid #ddd;"}

На картинке сверху получился меандр т.к. скважность 0.5. Треугольник может быть с любыми углами. Для проверки [поднимем](https://ngspice.js.org/?gist=86f37ddc1a91384f8a7e88988986c8d8) опорное напряжение с 5 до 7.5 командой ```alter v2 7.5```, чтобы скважность [была](https://bc.js.org/) ```(3.75-1.5)/(3.75-0.75) = 0.75```:

![screenshot]({attach}comparator-single-canvas-75.png){:style="width:100%; border:1px solid #ddd;"}

Осталось научиться генерировать треугольные импульсы и дело в шляпе. Один из вариантов использовать два ОУ - первый работает как триггер [Шмитта]({filename}../2016-11-24-op-amp-schmitt/2016-11-24-op-amp-schmitt.md), а второй - как [интегратор]({filename}../2016-11-30-op-amp-integrator-differentiator/2016-11-30-op-amp-integrator-differentiator.md).

[генератор треугольных импульсов на ОУ]({attach}triangle-generator.sch) | [netlist]({attach}triangle-generator.net) | [ngspice.js](https://ngspice.js.org/?gist=7eb81126c9ae10683180e8213c3e0099)

![screenshot]({attach}show-img-triangle-generator.png){:style="width:100%; border:1px solid #ddd;"}

    :::text
    ngspice 1 -> source triangle-generator.net
    ngspice 2 -> tran 10u 5m
    ngspice 3 -> plot v(out)

Частота треугольных импульсов [рассчитывается](https://bc.js.org/) по формуле ```1/(2*R5*C1) = 1/(2*10^5*10^-8) = 500 Гц```

![screenshot]({attach}triangle-generator-canvas.png){:style="width:100%; border:1px solid #ddd;"}

Далi буде.