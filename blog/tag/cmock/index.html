<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <title>üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó - CMock</title>
        <link rel="stylesheet" href="https://mazko.github.io/blog/theme/css/main.css" />
        <link href="https://mazko.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a rel="nofollow" href="http://github.com/mazko">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="https://mazko.github.io/">üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó </a></h1>
                <nav><ul>
                    <li><a href="https://mazko.github.io/blog/category/admin/">Admin</a></li>
                    <li><a href="https://mazko.github.io/blog/category/electronics/">Electronics</a></li>
                    <li><a href="https://mazko.github.io/blog/category/embedded/">Embedded</a></li>
                    <li><a href="https://mazko.github.io/blog/category/iot/">IoT</a></li>
                    <li><a href="https://mazko.github.io/blog/category/java/">Java</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://mazko.github.io/blog/posts/2014/03/29/tdd-na-urovne-mikrokontrollerov-svezhii-vzgliad/">TDD –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ - —Å–≤–µ–∂–∏–π –≤–∑–≥–ª—è–¥</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-03-29T00:00:00+02:00">
                –°–± 29 –º–∞—Ä—Ç–∞ 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://mazko.github.io/blog/author/oleg-mazko/">Oleg Mazko</a>
        </address>
<p>In <a href="https://mazko.github.io/blog/category/embedded/">Embedded</a>.</p>
<p>tags: <a href="https://mazko.github.io/blog/tag/tdd">TDD</a> <a href="https://mazko.github.io/blog/tag/cmock">CMock</a> <a href="https://mazko.github.io/blog/tag/unity">Unity</a> </p>
</footer><!-- /.post-info --><p>–¢–µ–º–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ü–û –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∏–∫ —É–∂–µ <a href="https://mazko.github.io/blog/posts/2012/10/07/manchesterskii-kod-dlia-chainikov/">–ø–æ–¥–Ω–∏–º–∞–ª–∞—Å—å</a>. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –µ—Å–ª–∏ –≤–∫—Ä–∞—Ç—Ü–µ, —Ç–æ –±—ã–ª–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—è—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ª–æ–≥–∏–∫—É –Ω–∞ –ü–ö –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∂–µ–ª–µ–∑–∞. –¢–∞–∫–æ–π <em>–Ω–∞–∏–≤–Ω—ã–π</em> –ø–æ–¥—Ö–æ–¥ —Å–ø–æ—Å–æ–±–µ–Ω –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∂–∏–∑–Ω—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É, –Ω–æ –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è –∏–º–µ–µ—Ç —Å–µ—Ä—å—ë–∑–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ —Å—Ç—ã–∫–µ —Å–æ—Ñ—Ç–∞ –ø–µ—Ä–µ—Ñ–∏—Ä–∏–∏:</p>
<ul>
<li>
<p>—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –æ–±—ä—ë–º –∫–æ–¥–∞ –∑–∞ —Å—á—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ <code>#ifdef</code> –Ω–∞ —Å—Ç—ã–∫–µ —Å –ø–µ—Ä–∏—Ñ–µ—Ä–∏–µ–π (–≤—Å—è–∫–∏–µ <em>UART</em>, <em>I2C</em>, –ø–æ—Ä—Ç—ã –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ –∏ —Ç.–¥.). –ù–∞–ø—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫—É –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –±–∏—Ç–æ–≤ –ø–æ—Ä—Ç–æ–≤ –º–æ–∂–Ω–æ –∑–∞–≤–µ—Ä–Ω—É—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏—é <code>set_flag()</code> –∏ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤. –µ–π <em>mock</em> - –æ–¥–Ω–∞–∫–æ —ç—Ç–æ —É–≤–µ–ª–∏—á–∏—Ç –æ–±—â–∏–π –æ–±—ä—ë–º –∫–æ–¥–∞</p>
</li>
<li>
<p>–Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –∫–æ–¥ —á–∞—Å—Ç–æ —Ç–∞–∫ –∏ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–¥–æ–ø–æ–∫—Ä—ã—Ç—ã–º —Ç–µ—Å—Ç–∞–º–∏. –ö –ø—Ä–∏–º–µ—Ä—É –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏–º–µ—é—Ç —Å–≤–æ–π—Å—Ç–≤–æ –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º —Å–æ–±—ã—Ç–∏—è–º –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–ª–∞–≥–∏, –Ω–∞–ø–æ–ª–Ω—è—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä—ã –¥–∞–Ω–Ω—ã–º–∏ - –∏–∑–æ–±—Ä–µ—Ç–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –∏ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ –º–æ–¥—É–ª–∏ ? –ö–∞–∫ –º–∏–Ω–∏–º—É–º –Ω—É–∂–Ω–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –∫–∞–∫ —ç—Ç–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–ª—é—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å</p>
</li>
<li>
<p>–Ω—É –∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∏—á —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —Ç–∏–ø–∞ <a href="http://www.microchip.com/stellent/groups/SiteComm_sg/documents/DeviceDoc/en557154.pdf" rel="nofollow">MIPS16</a> –≤–æ–æ–±—â–µ –∏ –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è</p>
</li>
</ul>
<p>–ò—Ç–∞–∫ –¥–∞–ª–µ–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω –ø—Ä–∏–º–µ—Ä —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ <em>Microchip</em>, <strong>—ç–º—É–ª—è—Ç–æ—Ä–∞</strong> –∏ TDD —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ <a href="http://throwtheswitch.org/" rel="nofollow">Ceedling</a>. –≠–º—É–ª—è—Ç–æ—Ä –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ü–ö –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –∞ <em>Ceedling</em> —ç—Ç–æ –Ω–µ –±–æ–ª–µ–µ —á–µ–º —Å—Ä–µ–¥—Å—Ç–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ <em>Ruby</em> –ø–ª—é—Å –≤—Å—ë —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏ –∫–æ–¥–∞ –Ω–∞ <em>C</em> (<em>Unity</em>, <em>CMock</em> –∏ –¥–∞–∂–µ <em>CException</em>).</p>
<div class="highlight"><pre><span></span><span class="c1">#apt-get install ruby</span>
~$ gem install ceedling
~$ ceedling new PIC_Demo
~$ <span class="nb">cd</span> PIC_Demo/
~$ ls
build  project.yml  rakefile.rb  src  <span class="nb">test</span>  vendor
</pre></div>


<p>–ï—â—ë –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è <em>C</em> –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ <em>PIC</em> –∏ —Å—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ <em>MPLAB</em>. –í—Å—ë —ç—Ç–æ –º–æ–∂–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ <em>Microchip</em> –∏ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —ç—Ç–æ–≥–æ –¥–æ–±—Ä–∞ –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ:</p>
<div class="highlight"><pre><span></span>~$ which xc16-gcc
/opt/microchip/xc16/v1.21/bin/xc16-gcc
~$ which mplab_ide 
/usr/bin/mplab_ide
</pre></div>


<p>–ù–∏–∫–∞–∫ –Ω–µ –æ–±–æ–π—Ç–∏—Å—å –Ω–∞–º –±–µ–∑ <em>Hello World</em>:</p>
<p><em>src/hello.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt; /* Required for printf */</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>–ö–æ–º–ø–∏–ª—è—Ü–∏—è + –ª–∏–Ω–∫–æ–≤–∫–∞:</p>
<div class="highlight"><pre><span></span>~$ xc16-gcc -omf<span class="o">=</span>elf -mcpu<span class="o">=</span>24EP64MC206 src/hello.c <span class="se">\</span>
-o build/hello.elf -Wl,-Tp24EP64MC206.gld
~$ file build/hello.elf
build/hello.elf: ELF <span class="m">32</span>-bit LSB executable, <span class="se">\</span>
version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, not stripped
</pre></div>


<p>–≠–º—É–ª—è—Ü–∏—è. –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ª—É—á–∞–π - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <em>sim30</em>, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å <em>–°</em> –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º <em>xc16-gcc</em>:</p>
<div class="highlight"><pre><span></span>~$ <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">LD pic24epsuper</span>
<span class="s2">LC build/hello.elf</span>
<span class="s2">IO NULL /tmp/</span><span class="nv">$$</span><span class="s2">.txt</span>
<span class="s2">RP</span>
<span class="s2">E</span>
<span class="s2">Q</span>
<span class="s2">&quot;</span> <span class="p">|</span> sim30
~$ cat /tmp/<span class="nv">$$</span>.txt
Hello, world!
</pre></div>


<p>–ü—Ä–µ–ª–µ—Å—Ç–Ω–æ ! –í–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ –ø—Ä–∏ —ç–º—É–ª—è—Ü–∏–∏ –≤ <em>sim30</em> –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ <em>—Å–µ–º–µ–π—Å—Ç–≤–∞</em> —á–∏–ø–æ–≤, –∞ –Ω–µ –∫–∞–∫–æ–π-–ª–∏–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏:</p>
<div class="highlight"><pre><span></span>~$ <span class="nb">echo</span> DH <span class="p">|</span> sim30 <span class="p">|</span> grep LD 
LD &lt;devicename&gt; -Load Device: <span class="se">\</span>
dspic30super dspic33epsuper pic24epsuper pic24fpsuper pic24super
</pre></div>


<p>–ö–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —ç–º—É–ª—è—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–µ –≤—Å—è –∏–º–µ—é—â–∞—è—Å—è –Ω–∞ –±–æ—Ä—Ç—É –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è –∏ –æ–± —ç—Ç–æ–º –º—ã –µ—â—ë –ø–æ–≥–æ–≤–æ—Ä–∏–º —á—É—Ç—å –ø–æ–∑–∂–µ, –Ω—É –∞ —Å–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞—Ç—å –ø–æ–ª—É—á–∞—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –æ—Ç —é–Ω–∏—Ç —Ç–µ—Å—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º <a href="http://throwtheswitch.org/" rel="nofollow">Ceedling</a>. –í <em>Hello World</em> –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è main. –ù–µ —Å–µ–∫—Ä–µ—Ç, —á—Ç–æ –≤ <em>C</em> –ø—Ä–æ–≥—Ä–∞–º–º–µ —Ñ—É–Ω–∫—Ü–∏—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞, –∞ –ø–æ—Å–∫–æ–ª—å–∫—É –≤ <em>Ceedling</em> –æ–Ω–∞ —É–∂–µ —è–≤–Ω–æ –∏–º–µ–µ—Ç—Å—è, –¥–ª—è —Ç–µ—Å—Ç–æ–≤ <em>hello.c</em> —Ç—É—Ç –Ω—É–∂–Ω—ã <code>#ifdef</code> - –Ω–æ —ç—Ç–æ —á–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –ø—Ä–∞–≤–∏–ª —Ç–∞–∫ —Å–∫–∞–∑–∞—Ç—å –∏ –ø—É–≥–∞—Ç—å—Å—è –Ω–µ —Å—Ç–æ–∏—Ç:</p>
<p><em>src/hello.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#ifndef hello_H</span>
<span class="cp">#define hello_H</span>

<span class="cp">#ifdef TEST</span>
<span class="kt">int</span> <span class="nf">test_main</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="c1">// hello_H</span>
</pre></div>


<p><em>src/hello.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt; /* Required for printf */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hello.h&quot;</span><span class="cp"></span>
<span class="cp">#ifdef TEST</span>
<span class="kt">int</span> <span class="nf">test_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><em>test/test_main.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;unity.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hello.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_main_function_should_always_return_0</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">test_main</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>


<p>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é <em>Ceedling</em> –∑–∞—Ç–æ—á–µ–Ω –ø–æ–¥ <em>gcc</em>, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –¥–æ–ø–∏–ª–∏—Ç—å <em>project.yml</em>, —É–∫–∞–∑–∞–≤ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä, –ª–∏–Ω–∫–æ–≤—â–∏–∫ –≤ —Å–µ–∫—Ü–∏–∏ <code>:tools:</code>:</p>
<p><em>project.yml</em></p>
<div class="highlight"><pre><span></span>:tools:
  :test_compiler:
    :executable: xc16-gcc
    :arguments:
      - -mcpu=24EP64MC206
      - -x c
      - -c
      - &quot;${1}&quot;
      - -o &quot;${2}&quot;
      - -D$: COLLECTION_DEFINES_TEST_AND_VENDOR
      - -I&quot;$&quot;: COLLECTION_PATHS_TEST_SUPPORT_SOURCE_INCLUDE_VENDOR
      - -Wall
      - -Wextra
      - -mlarge-code
      - -mlarge-arrays
      - -mlarge-data
  :test_linker:
    :executable: xc16-gcc
    :arguments:
      - -mcpu=24EP64MC206
      - -omf=elf
      - ${1}
      - -o &quot;./build/TestBuild.out&quot;
      - -Wl,-Tp24EP64MC206.gld
</pre></div>


<p>–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:</p>
<div class="highlight"><pre><span></span><span class="c1"># –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π Ceedling</span>
<span class="c1"># rake -T</span>
~$ rake test:all
<span class="c1"># build/test/out/cmock.o: Link Error: \</span>
<span class="c1"># Could not allocate section .bss, size = 32774 bytes, attributes = bss </span>
<span class="c1"># Link Error: Could not allocate data memory</span>
</pre></div>


<p>–õ–∏–Ω–∫–æ–≤—â–∏–∫ —Ä—É–≥–∞–µ—Ç—Å—è - –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å <em>cmock</em>, –ø–æ—ç—Ç–æ–º—É —É–º–µ–Ω—å—à–∏–º –∞–ø–ø–µ—Ç–∏—Ç—ã —ç—Ç–æ–≥–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ —Å–µ–∫—Ü–∏–∏ <code>:defines:</code>:</p>
<p><em>project.yml</em></p>
<div class="highlight"><pre><span></span>:commmon: &amp;common_defines
  - UNITY_INT_WIDTH=16
  - CMOCK_MEM_INDEX_TYPE=uint16_t
  - CMOCK_MEM_PTR_AS_INT=uint16_t
  - CMOCK_MEM_ALIGN=1
  - CMOCK_MEM_SIZE=4096
</pre></div>


<p>–ü—Ä–æ–±—É–µ–º:</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># ERROR: Test executable &quot;test_main.out&quot; failed.</span>
<span class="c1"># &gt; Produced no final test result counts in $stdout:</span>
<span class="c1"># sh: 1: build/test/out/test_main.out: not found</span>
<span class="c1"># &gt; And exited with status: [127] (count of failed tests).</span>
<span class="c1"># &gt; This is often a symptom of a bad memory access in source or test code.</span>
</pre></div>


<p>–¢—É—Ç <em>Ceedling</em> –Ω–∞–∏–≤–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É <em>test_main.out</em>, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç –∫–∞–∫, –∑–∞—Ç–æ –º—ã –∑–Ω–∞–µ–º —á—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é <em>sim30</em>:</p>
<p><em>test/simulation/sim30_instruction.txt</em></p>
<div class="highlight"><pre><span></span>LD pic24epsuper
LC ./build/TestBuild.out
IO NULL ./test/simulation/out.txt
RP
E
quit
</pre></div>


<p><em>test/simulation/sim_test_fixture.rb</em></p>
<div class="highlight"><pre><span></span><span class="no">OUT_FILE</span> <span class="o">=</span> <span class="s2">&quot;test/simulation/out.txt&quot;</span>
<span class="no">File</span><span class="o">.</span><span class="n">delete</span> <span class="no">OUT_FILE</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="no">OUT_FILE</span>
<span class="n">pipe</span><span class="o">=</span><span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;sim30 ./test/simulation/sim30_instruction.txt&quot;</span><span class="p">)</span>

<span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="no">Process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&quot;KILL&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">pid</span><span class="p">);</span> <span class="nb">exit</span> <span class="p">}</span>

<span class="no">Process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="no">OUT_FILE</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span> <span class="no">OUT_FILE</span>
    <span class="nb">print</span> <span class="n">file_contents</span>
<span class="k">else</span>
    <span class="nb">print</span> <span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">\</span>
          <span class="s2">&quot;! Program was not simulated ? !</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">\</span>
          <span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>
<span class="k">end</span>
</pre></div>


<p>–†–∞—Å—Å–∫–∞–∑–∞—Ç—å <em>Ceedling</em> –≤ —Å–µ–∫—Ü–∏–∏ <code>:tools:</code> –∫–∞–∫ –≤—Å–µ–º —ç—Ç–∏–º —É–ø—Ä–∞–≤–ª—è—Ç—å:</p>
<p><em>project.yml</em> </p>
<div class="highlight"><pre><span></span>:test_fixture:
  :executable: ruby
  :name: &quot;Microchip simulator test fixture&quot;
  :stderr_redirect: :win
  :arguments:
    - test/simulation/sim_test_fixture.rb
</pre></div>


<p>–ó–∞–ø—É—Å–∫... –í—É–∞–ª—è !</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># ----------------------</span>
<span class="c1"># UNIT TEST OTHER OUTPUT</span>
<span class="c1"># ----------------------</span>
<span class="c1"># [test_main.c]</span>
<span class="c1">#   - &quot;Hello, world!&quot;</span>
<span class="c1"># -------------------------</span>
<span class="c1"># OVERALL UNIT TEST SUMMARY</span>
<span class="c1"># -------------------------</span>
<span class="c1"># TESTED:  1</span>
<span class="c1"># PASSED:  1</span>
<span class="c1"># FAILED:  0</span>
<span class="c1"># IGNORED: 0</span>
</pre></div>


<p>–í–æ—Ç ! –¢–µ–ø–µ—Ä—å –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –∂–∏—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å —Ç–µ—Å—Ç–∞–º–∏. –ü—Ä–µ–¥–ª–∞–≥–∞—é –ø–æ–º–∏–≥–∞—Ç—å —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º –∏ mock–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∞:</p>
<p><em>src/gpio_led.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#ifndef gpio_led_H</span>
<span class="cp">#define gpio_led_H</span>

<span class="kt">void</span> <span class="nf">gpio_led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">gpio_led_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">gpio_led_clear</span><span class="p">();</span>

<span class="cp">#endif </span><span class="c1">// gpio_H</span>
</pre></div>


<p><em>src/system.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#ifndef system_H</span>
<span class="cp">#define system_H</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>

<span class="kt">bool</span> <span class="nf">system_should_abort_app</span><span class="p">();</span>

<span class="cp">#endif </span><span class="c1">// system_H</span>
</pre></div>


<p><em>src/hello.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;hello.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;system.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gpio_led.h&quot;</span><span class="cp"></span>
<span class="cp">#ifdef TEST</span>
<span class="kt">int</span> <span class="nf">test_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
    <span class="n">gpio_led_init</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">system_should_abort_app</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">gpio_led_set</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
        <span class="n">gpio_led_clear</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><em>test/test_main.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;unity.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hello.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mock_system.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mock_gpio_led.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">gpio_led_init_Expect</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_main_function_without_loop</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">system_should_abort_app_ExpectAndReturn</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">test_main</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_main_function_loop_one_iteration</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">system_should_abort_app_ExpectAndReturn</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="n">gpio_led_set_Expect</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
    <span class="n">gpio_led_clear_Expect</span><span class="p">();</span>
    <span class="n">system_should_abort_app_ExpectAndReturn</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">test_main</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>


<p>–ü—Ä–æ–±—É–µ–º:</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># -------------------------</span>
<span class="c1"># OVERALL UNIT TEST SUMMARY</span>
<span class="c1"># -------------------------</span>
<span class="c1"># TESTED:  2</span>
<span class="c1"># PASSED:  2</span>
<span class="c1"># FAILED:  0</span>
<span class="c1"># IGNORED: 0</span>
</pre></div>


<p>–ö–∞–∫ –Ω–µ—Å–ª–æ–∂–Ω–æ –¥–æ–≥–∞–¥–∞—Ç—å—Å—è –∏–∑ <em>test/test_main.c</em> –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç —Ç–µ—Å—Ç–∞ <em>Ceedling</em> –ª–∏–Ω–∫—É–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –µ–≥–æ <code>#include</code>, –ø—Ä–∏—á—ë–º –µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å <code>mock</code>, –≤–º–µ—Å—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π <em>*.c</em> –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏ <em>Ceedling</em> –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç <em>mock</em> —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É, –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω–æ–º—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º <em>*.h</em>. </p>
<p>–ß—É—Ç—å –±–ª–∏–∂–µ –∫ –∂–µ–ª–µ–∑—É –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –ø–æ—Ä—Ç–æ–≤ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞:</p>
<p><em>src/gpio_led.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;gpio_led.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;xc.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">gpio_led_init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">TRISAbits</span><span class="p">.</span><span class="n">TRISA0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gpio_led_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* TODO: brightness :) */</span>
    <span class="n">LATAbits</span><span class="p">.</span><span class="n">LATA0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gpio_led_clear</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">LATAbits</span><span class="p">.</span><span class="n">LATA0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><em>test/test_gpio_led.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;unity.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gpio_led.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;xc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">gpio_led_init</span><span class="p">();</span>
    <span class="n">LATABITS</span> <span class="n">clean</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">LATAbits</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clean</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">clean</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_gpio_led_set</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LATAbits</span><span class="p">.</span><span class="n">LATA0</span><span class="p">);</span>
    <span class="n">gpio_led_set</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">LATAbits</span><span class="p">.</span><span class="n">LATA0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_gpio_led_clear</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">test_gpio_led_set</span><span class="p">();</span>
    <span class="n">gpio_led_clear</span><span class="p">();</span>
    <span class="n">TEST_ASSERT_EQUAL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LATAbits</span><span class="p">.</span><span class="n">LATA0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>–ü—Ä–æ–±—É–µ–º:</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># -------------------------</span>
<span class="c1"># OVERALL UNIT TEST SUMMARY</span>
<span class="c1"># -------------------------</span>
<span class="c1"># TESTED:  4</span>
<span class="c1"># PASSED:  4</span>
<span class="c1"># FAILED:  0</span>
<span class="c1"># IGNORED: 0</span>
</pre></div>


<p>–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ —Ç–∞–∫–æ–π <em>TDD</em> –ø–æ–¥—Ö–æ–¥ –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —É–¥–æ–±–Ω–µ–µ <a href="https://mazko.github.io/blog/posts/2012/10/07/manchesterskii-kod-dlia-chainikov/">–ø—Ä–µ–¥—ã–¥—É—â–∏—Ö</a>. –¢—É—Ç –æ—á–µ–Ω—å –º–Ω–æ–≥–æ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —ç–º—É–ª—è—Ç–æ—Ä–∞ –∏ –∏–Ω–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ <em>sim30</em> –±—ã–≤–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –¢–∏–ø–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä - –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π:</p>
<p><em>src/gpio_button.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#ifndef gpio_button_H</span>
<span class="cp">#define gpio_button_H</span>

<span class="kt">void</span> <span class="nf">gpio_button_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif </span><span class="c1">// gpio_H</span>
</pre></div>


<p><em>src/gpio_button.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;gpio_button.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gpio_led.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;xc.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">gpio_button_init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">TRISFbits</span><span class="p">.</span><span class="n">TRISF0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">CNENFbits</span><span class="p">.</span><span class="n">CNIEF0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IFS1bits</span><span class="p">.</span><span class="n">CNIF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IEC1bits</span><span class="p">.</span><span class="n">CNIE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">interrupt</span><span class="p">,</span><span class="n">auto_psv</span><span class="p">))</span> <span class="n">_CNInterrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IFS1bits</span><span class="p">.</span><span class="n">CNIF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">gpio_led_set</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><em>test/test_gpio_button.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;unity.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gpio_button.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mock_gpio_led.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;xc.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">gpio_button_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_gpio_button_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">gpio_led_set_Expect</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
    <span class="n">IFS1bits</span><span class="p">.</span><span class="n">CNIF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">asm</span><span class="p">(</span><span class="s">&quot;NOP&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>–£–ø—Å:</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># ------------------------</span>
<span class="c1"># FAILED UNIT TEST SUMMARY</span>
<span class="c1"># ------------------------</span>
<span class="c1"># [test_gpio_button.c]</span>
<span class="c1"># Test: test_gpio_button_interrupt</span>
<span class="c1"># At line (13): &quot;Function &#39;gpio_led_set&#39; called less times than expected&quot;</span>
</pre></div>


<p>–ü–æ—Ö–æ–∂–µ —ç–º—É–ª—è—Ç–æ—Ä <em>sim30</em> –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º—É–ª—è—Ç–æ—Ä <em>mdb</em> –∏–∑ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ <em>MPLAB</em>. –¢–µ–∫—É—â–∏–π <em>MPLAB X IDE v2.05</em> –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ <em>Java</em> –∏ –ø–æ—ç—Ç–æ–º—É —ç–º—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å –Ω–µ–±—ã—Å—Ç—Ä–æ, –Ω—É –º–∞–µ–º–æ —Ç–µ —à–æ –º–∞–µ–º–æ:</p>
<p><em>test/simulation/mplab_sim_instructions.txt</em></p>
<div class="highlight"><pre><span></span>Device PIC24EP64MC206
Hwtool SIM -p
Program ./build/TestBuild.out
Run
Quit
</pre></div>


<p><em>test/simulation/sim_test_fixture.rb</em></p>
<div class="highlight"><pre><span></span><span class="no">OUT_FILE</span> <span class="o">=</span> <span class="s2">&quot;test/simulation/out.txt&quot;</span>
<span class="no">File</span><span class="o">.</span><span class="n">delete</span> <span class="no">OUT_FILE</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="no">OUT_FILE</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;/opt/microchip/mplabx/mplab_ide/bin/mdb.sh &quot;</span>   <span class="p">\</span>
                <span class="s2">&quot;./test/simulation/mplab_sim_instructions.txt &quot;</span> <span class="p">\</span>
                <span class="s2">&quot;&gt; </span><span class="si">#{</span><span class="no">OUT_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="no">Process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&quot;KILL&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">pid</span><span class="p">);</span> <span class="nb">exit</span> <span class="p">}</span>

<span class="no">Process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
<span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="no">OUT_FILE</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span> <span class="no">OUT_FILE</span>
    <span class="nb">print</span> <span class="n">file_contents</span>
<span class="k">else</span>
    <span class="nb">print</span> <span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">\</span>
          <span class="s2">&quot;! Program was not simulated ? !</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">\</span>
          <span class="s2">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>
<span class="k">end</span>
</pre></div>


<p>–§–∏–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥:</p>
<div class="highlight"><pre><span></span>~$ rake test:all
<span class="c1"># -------------------------</span>
<span class="c1"># OVERALL UNIT TEST SUMMARY</span>
<span class="c1"># -------------------------</span>
<span class="c1"># TESTED:  5</span>
<span class="c1"># PASSED:  5</span>
<span class="c1"># FAILED:  0</span>
<span class="c1"># IGNORED: 0</span>
</pre></div>


<p>–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ <a href="https://mazko.github.io/blog/posts/2014/03/29/tdd-na-urovne-mikrokontrollerov-svezhii-vzgliad/PIC_Demo.zip">—Ç—É—Ç</a>.</p><p>There are <a href="https://mazko.github.io/blog/posts/2014/03/29/tdd-na-urovne-mikrokontrollerov-svezhii-vzgliad/#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a rel="nofollow" href="http://getpelican.com/">Pelican</a></li>
                            <li><a rel="nofollow" href="http://python.org/">Python.org</a></li>
                            <li><a rel="nofollow" href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://mazko.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a rel="nofollow" href="http://github.com/mazko">github</a></li>
                            <li><a rel="nofollow" href="http://linkedin.com/in/mazko">linkedin</a></li>
                            <li><a rel="nofollow" href="http://stackoverflow.com/users/281102/oleg-mazko">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'mazko';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>