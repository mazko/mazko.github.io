<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <title>–°++ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ - ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª</title>
        <link rel="stylesheet" href="https://mazko.github.io/blog/theme/css/main.css" />
        <link href="https://mazko.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://mazko.github.io/">üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó </a></h1>
                <nav><ul>
                    <li><a href="https://mazko.github.io/blog/category/admin/">Admin</a></li>
                    <li><a href="https://mazko.github.io/blog/category/electronics/">Electronics</a></li>
                    <li class="active"><a href="https://mazko.github.io/blog/category/embedded/">Embedded</a></li>
                    <li><a href="https://mazko.github.io/blog/category/iot/">IoT</a></li>
                    <li><a href="https://mazko.github.io/blog/category/java/">Java</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://mazko.github.io/blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/" rel="bookmark"
           title="Permalink to –°++ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ - ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª">–°++ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ - ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-18T00:00:00+02:00">
                –í—Å 18 –º–∞—Ä—Ç–∞ 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://mazko.github.io/blog/author/oleg-mazko/">Oleg Mazko</a>
        </address>
<p>In <a href="https://mazko.github.io/blog/category/embedded/">Embedded</a>.</p>
<p>tags: <a href="https://mazko.github.io/blog/tag/msp430">msp430</a> <a href="https://mazko.github.io/blog/tag/pattern">–ü–∞—Ç—Ç–µ—Ä–Ω</a> </p>
</footer><!-- /.post-info -->      <p>–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å—Å—è –∫ <a href="https://mazko.github.io/blog/posts/2017/03/20/s-18-dlia-mikrokontrollerov-razvedka-boem/">C++ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤</a>.</p>
<p>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å ‚Äì —ç—Ç–æ <a href="https://mazko.github.io/blog/posts/2017/03/22/s-dlia-mikrokontrollerov-dekorator/">–ø–∞—Ç—Ç–µ—Ä–Ω</a> –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –æ–¥–Ω–∏–º –æ–±—ä–µ–∫—Ç–∞–º —Å–ª–µ–¥–∏—Ç—å –∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–∏–µ –≤ –¥—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö. –î–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω —á–∞—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—é—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.</p>
<p><a href="https://mazko.github.io/blog/posts/2017/03/22/s-dlia-mikrokontrollerov-dekorator/">GoF</a> –¥–∞—ë—Ç —Å–ª–µ–¥—É—é—â–µ–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å (–∞–Ω–≥–ª. Observer) ‚Äì –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤–µ–¥–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ç–∏–ø–∞ ¬´–æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º¬ª –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤—Å–µ –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç –Ω–µ–≥–æ –æ–ø–æ–≤–µ—â–∞—é—Ç—Å—è –æ–± —ç—Ç–æ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.</p>
<p>–ê–Ω–∞–ª–æ–≥–∏—è –∏–∑ –∂–∏–∑–Ω–∏: –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—ã –æ—Ñ–æ—Ä–º–∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –≥–∞–∑–µ—Ç—É –∏–ª–∏ –∂—É—Ä–Ω–∞–ª, –≤–∞–º –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –µ–∑–¥–∏—Ç—å –≤ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ –≤—ã—à–µ–ª –ª–∏ –æ—á–µ—Ä–µ–¥–Ω–æ–π –Ω–æ–º–µ—Ä. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –ø—Ä—è–º–æ –∫ –≤–∞–º –¥–æ–º–æ–π. –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤–µ–¥—ë—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –∑–Ω–∞–µ—Ç, –∫–æ–º—É –∫–∞–∫–æ–π –∂—É—Ä–Ω–∞–ª —Å–ª–∞—Ç—å. –í—ã –º–æ–∂–µ—Ç–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –∏ –∂—É—Ä–Ω–∞–ª –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –∫ –≤–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—å.</p>
<p><a href="http://mazko.github.io/MSP430.js/8490b771b5c0189e639726f219cb2b16">MSP430.js</a> | <a href="https://mazko.github.io/blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/msp430-observer.zip">–∏—Å—Ö–æ–¥–Ω–∏–∫–∏</a></p>
<p><img alt="screenshot" src="https://mazko.github.io/blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/ui.gif" style="width:55%; margin: 0 auto; display:block;"></p>
<p>–î–∞–≤–∞–π—Ç–µ –Ω–∞–∑—ã–≤–∞—Ç—å ¬´–∏–∑–¥–∞—Ç–µ–ª—è–º–∏¬ª —Ç–µ –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤–∞–∂–Ω–æ–µ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–∞–∑–æ–≤—ë–º ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏¬ª.</p>
<p>–ü–∞—Ç—Ç–µ—Ä–Ω ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ ¬´–∏–∑–¥–∞—Ç–µ–ª—è¬ª (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤¬ª. –ü—Ä–∏—á—ë–º, ¬´–∏–∑–¥–∞—Ç–µ–ª—å¬ª –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –û–Ω –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä—ã—Ö ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∏¬ª –º–æ–≥–ª–∏ –±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –∏–ª–∏ —É–±–∏—Ä–∞—Ç—å —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞.</p>
<p>–ö–æ–≥–¥–∞ –≤ ¬´–∏–∑–¥–∞—Ç–µ–ª–µ¬ª –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, –æ–Ω –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ —Å–ø–∏—Å–∫—É ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤¬ª –∏ –æ–ø–æ–≤–µ—â–∞—Ç—å –∏—Ö –æ–± —ç—Ç–æ–º, –≤—ã–∑—ã–≤–∞—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—ä–µ–∫—Ç–æ–≤-–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.</p>
<p><em>observers/state.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;DoublyLinkedList.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;non-copyable.h&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">obsevers</span> <span class="p">{</span>

    <span class="c1">// alias</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">DLLE</span> <span class="o">=</span> <span class="n">mozilla</span><span class="o">::</span><span class="n">DoublyLinkedListElement</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">namespace</span> <span class="n">state</span> <span class="p">{</span>

        <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
            <span class="n">left_active</span><span class="p">,</span>
            <span class="n">left_sleep</span>
        <span class="p">}</span> <span class="n">state_t</span><span class="p">;</span>

        <span class="k">struct</span> <span class="nl">IObserver</span> <span class="p">:</span> <span class="k">public</span> <span class="n">DLLE</span><span class="o">&lt;</span><span class="n">IObserver</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">NonCopyable</span>
        <span class="p">{</span>
            <span class="k">virtual</span> <span class="kt">void</span> <span class="n">observe</span><span class="p">(</span><span class="n">state_t</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">};</span>


        <span class="k">class</span> <span class="nc">Container</span> <span class="o">:</span> <span class="n">NonCopyable</span>
        <span class="p">{</span>
            <span class="n">mozilla</span><span class="o">::</span><span class="n">DoublyLinkedList</span><span class="o">&lt;</span><span class="n">IObserver</span><span class="o">&gt;</span> <span class="n">mList</span><span class="p">;</span>

        <span class="k">public</span><span class="o">:</span>
            <span class="kt">void</span> <span class="n">addObserver</span><span class="p">(</span><span class="n">IObserver</span><span class="o">*</span> <span class="n">aObserver</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Will assert if |aObserver| is part of another list.</span>
                <span class="n">mList</span><span class="p">.</span><span class="n">pushFront</span><span class="p">(</span><span class="n">aObserver</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">void</span> <span class="n">removeObserver</span><span class="p">(</span><span class="n">IObserver</span><span class="o">*</span> <span class="n">aObserver</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Will assert if |aObserver| is not part of |list|.</span>
                <span class="n">mList</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">aObserver</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">void</span> <span class="n">notifyObservers</span><span class="p">(</span><span class="n">state_t</span> <span class="n">aState</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">IObserver</span><span class="o">&amp;</span> <span class="nl">o</span> <span class="p">:</span> <span class="n">mList</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">o</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="n">aState</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">extern</span> <span class="n">Container</span> <span class="n">event</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–í –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∏¬ª –æ–±—Ä–∞–∑—É—é—Ç –¥–≤—É—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏. –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –æ–ø–∏—Å–∞–Ω–æ <a href="https://mazko.github.io/blog/posts/2017/03/22/s-dlia-mikrokontrollerov-dekorator/">—Ç—É—Ç</a>. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤—É—Å–≤—è–∑–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤–∑—è—Ç–∞—è –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ mozilla.</p>
<p>–®–∞–±–ª–æ–Ω ¬´–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å¬ª —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –û–±—ã—á–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–µ–ª–æ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —á–∞—Å—Ç–µ–π: –≤—ã–±–æ—Ä–∫–∏ —Å–æ–±—ã—Ç–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è, –ø–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è.</p>
<p><em>app.cpp</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;app.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hal.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;observers/buttons.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;observers/state.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;tasks/left.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;tasks/right.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;tasks/counter.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">obsevers</span><span class="p">;</span>

<span class="n">buttons</span><span class="o">::</span><span class="n">Container</span> <span class="n">obsevers</span><span class="o">::</span><span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">;</span>
<span class="n">state</span><span class="o">::</span><span class="n">Container</span>   <span class="n">obsevers</span><span class="o">::</span><span class="n">state</span><span class="o">::</span><span class="n">event</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">app</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">tasks</span><span class="o">::</span><span class="n">left</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
        <span class="n">tasks</span><span class="o">::</span><span class="n">right</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
        <span class="n">tasks</span><span class="o">::</span><span class="n">counter</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>

        <span class="kt">char</span> <span class="n">lastBtns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">longPress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TODO: use timer</span>
        <span class="n">state</span><span class="o">::</span><span class="n">state_t</span> <span class="n">lastState</span> <span class="o">=</span> <span class="n">state</span><span class="o">::</span><span class="n">left_sleep</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

            <span class="kt">char</span> <span class="n">btns</span> <span class="o">=</span> <span class="n">hal</span><span class="o">::</span><span class="n">get_buttons</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lastBtns</span> <span class="o">&amp;&amp;</span> <span class="n">btns</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">notifyObservers</span><span class="p">(</span><span class="n">btns</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">btns</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="cm">/* left first button */</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">longPress</span> <span class="o">&amp;&amp;</span> <span class="o">!--</span><span class="n">longPress</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="k">switch</span> <span class="p">(</span><span class="n">lastState</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_active</span><span class="p">:</span>
                            <span class="n">lastState</span> <span class="o">=</span> <span class="n">state</span><span class="o">::</span><span class="n">left_sleep</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_sleep</span><span class="p">:</span>
                            <span class="n">lastState</span> <span class="o">=</span> <span class="n">state</span><span class="o">::</span><span class="n">left_active</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">state</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">notifyObservers</span><span class="p">(</span><span class="n">lastState</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">longPress</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">lastBtns</span> <span class="o">=</span> <span class="n">btns</span><span class="p">;</span>

            <span class="c1">// other events like timer e.t.c...</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –¥–≤–∞ —Å–æ–±—ã—Ç–∏—è: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ) –ª–µ–≤—ã–µ –ª–∞–º–ø–æ—á–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è / –æ—Ç–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –æ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏. –ü—Ä–∞–≤—ã–µ –ª–∞–º–ø–æ—á–∫–∏ –∏ —Å—á—ë—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ –≤—Å–µ–≥–¥–∞.</p>
<p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤¬ª. –ú–µ—Ç–æ–¥ <code>addObserver</code> –∫–ª–∞—Å—Å–∞ <code>state::Container</code> –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∞¬ª –≤ –Ω–∞—á–∞–ª–æ —Å–≤—è–∑–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞. –ê –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ –≤ –Ω–∞—á–∞–ª–æ –∞ –≤ –∫–æ–Ω–µ—Ü ? –ö–∞–∫–æ–π –ø–æ—Ä—è–¥–æ–∫ —Å—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ? <strong>–õ—é–±–æ–π</strong>. –ù—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∫–æ–¥ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ö–æ–¥–∞ ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤¬ª –Ω–∏–∫–∞–∫ –Ω–µ –≤–ª–∏—è–ª –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ß–µ–º –º–µ–Ω—å—à–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∑–Ω–∞—é—Ç –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ, —Ç–µ–º –ø—Ä–æ—â–µ –∏—Ö –∏–∑–º–µ–Ω—è—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å. –û —Å–∏–ª–µ —Å–ª–∞–±—ã—Ö —Å–≤—è–∑–µ–π —á—É—Ç—å –Ω–∏–∂–µ.</p>
<p><em>tasks/left.cpp</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;left.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;color-observer.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;observers/state.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;draw.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hal.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">obsevers</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">tasks</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LockerObserver</span> <span class="o">:</span> <span class="k">public</span> <span class="n">state</span><span class="o">::</span><span class="n">IObserver</span> <span class="p">{</span>

    <span class="n">ColorObserver</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">LeftLeds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="n">o</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">observe</span><span class="p">(</span><span class="n">state</span><span class="o">::</span><span class="n">state_t</span> <span class="n">aState</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">aState</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_active</span><span class="p">:</span>
                <span class="n">str</span><span class="p">(</span><span class="s">&quot;left subscribed  &quot;</span><span class="p">);</span>
                <span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_sleep</span><span class="p">:</span>
                <span class="n">str</span><span class="p">(</span><span class="s">&quot;left unsubscribed&quot;</span><span class="p">);</span>
                <span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span><span class="o">:</span> 
        <span class="kt">void</span> <span class="n">str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">draw</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">draw</span><span class="o">::</span><span class="n">PAGE_0</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LockerObserver</span> <span class="n">observer</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">tasks</span> <span class="p">{</span>
    <span class="k">namespace</span> <span class="n">left</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">observer</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;left unsubscribed&quot;</span><span class="p">);</span>
            <span class="n">state</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observer</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç—ã –º–æ–≥—É—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–µ –æ–±–ª–∞–¥–∞—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ, —Ç–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞–∑—ã–≤–∞—é—Ç —Å–ª–∞–±–æ—Å–≤—è–∑–∞–Ω–Ω—ã–º–∏. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –∑–Ω–∞–µ—Ç ¬´–∏–∑–¥–∞—Ç–µ–ª—å¬ª –æ ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∞—Ö¬ª, ‚Äì —Ç–æ, —á—Ç–æ –æ–Ω–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (IObserver). –ï–º—É –Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª–∞—Å—Å ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–∞¬ª, –Ω–∏ –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ ¬´–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤¬ª –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ ¬´–∏–∑–¥–∞—Ç–µ–ª—è¬ª. </p>
<p>–ù–∞ –±–∞–∑–µ —Å–ª–∞–±–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä —Å—Ç—Ä–æ—è—Ç—Å—è –≥–∏–±–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ä–æ—à–æ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –±–ª–∞–≥–æ–¥–∞—Ä—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏.</p>
<blockquote>
<p>–ï—Å—Ç—å –≤—Å–µ–≥–æ –¥–≤–∞ —Ç–∏–ø–∞ —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: —Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –ª—é–¥–∏ –≤—Å—ë –≤—Ä–µ–º—è —Ä—É–≥–∞—é—Ç—Å—è, –∏ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç. ‚Äî Bjarne Stroustrup</p>
</blockquote>
<p>–ö–∞–∫ –≤—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ –≤—ã–≤–µ–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞ ?</p>
<div class="highlight"><pre><span></span>~$ strings a.out | grep alloc
# output
lib_a-malloc.o
lib_a-nano-mallocr.o
malloc
_malloc_r
__malloc_sbrk_start
__malloc_free_list
</pre></div>


<p>–ö–∞–∫ —Ç–æ–ª—å–∫–æ –º—ã –Ω–∞—á–∞–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <strong>–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</strong>, –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —Ä–µ—à–∏–ª –ø–æ–º–æ—á—å –∏ –º–æ–ª—á–∞ –¥–æ–±–∞–≤–∏–ª –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª <code>malloc</code> –∏ —ç—Ç–æ <a href="https://mazko.github.io/blog/posts/2017/03/22/s-dlia-mikrokontrollerov-dekorator/">—è–≤–Ω–æ –Ω–µ —Ç–æ</a>, —á—Ç–æ –º—ã —Ö–æ—Ç–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö. –ú–æ–∂–Ω–æ –ª–∏ —ç—Ç–æ –∫–∞–∫-—Ç–æ –æ–±–æ–π—Ç–∏ ?</p>
<p>–£ –Ω–∞—Å —Ç—É—Ç GCC-–ø–æ–¥–æ–±–Ω—ã–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä, –∫–æ–º–ø–æ–Ω–æ–≤—â–∏–∫ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏ –æ–±—ë—Ä—Ç–∫–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏. –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–æ–º–∞—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ <code>malloc</code>, <code>calloc</code>, <code>realloc</code>, <code>free</code>:</p>
<div class="highlight"><pre><span></span>-fno-builtin -Wl,--wrap=malloc  -Wl,--wrap=calloc \
             -Wl,--wrap=realloc -Wl,--wrap=free -Wl,--wrap=sbrk
</pre></div>


<p>–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—ã–∑–æ–≤–µ <code>malloc</code> –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ <code>__wrap_malloc</code> –∏ —Ç.–¥. –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é <code>__wrap_malloc</code>, –∫–æ–º–ø–∏–ª—è—Ü–∏—è —Å–ª–æ–º–∞–µ—Ç—Å—è. –ï—Å–ª–∏ –∂–µ <code>malloc</code> –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –≤—ã–¥–∞—Å—Ç –ø—Ä–æ—à–∏–≤–∫—É.</p>
<p><a href="http://mazko.github.io/MSP430.js/9bdb1cd8da54384ba5b6211ea135b7f8">MSP430.js</a> | <a href="https://mazko.github.io/blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/msp430-observer-static-polymorphism.zip">–∏—Å—Ö–æ–¥–Ω–∏–∫–∏</a></p>
<p>–í —Å—Ç–∞—Ä–æ–º –¥–æ–±—Ä–æ–º C–∏ –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –≤–∏–¥–µ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏. –ù–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ C–∏ ‚Äì —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ qsort. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–∞: —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å ¬´—É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –∫–æ–¥¬ª, –≤ –Ω–∏—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞—á–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —É—á–∞—Å—Ç–∫–∞ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞. –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —É–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏—à—å –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –æ –≤—ã–∑–æ–≤–µ.</p>
<p><em>observers/state.h</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;DoublyLinkedList.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;non-copyable.h&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">obsevers</span> <span class="p">{</span>

    <span class="c1">// alias</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">DLLE</span> <span class="o">=</span> <span class="n">mozilla</span><span class="o">::</span><span class="n">DoublyLinkedListElement</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">namespace</span> <span class="n">state</span> <span class="p">{</span>

        <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
            <span class="n">left_active</span><span class="p">,</span>
            <span class="n">left_sleep</span>
        <span class="p">}</span> <span class="n">state_t</span><span class="p">;</span>

        <span class="k">class</span> <span class="nc">Observer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">DLLE</span><span class="o">&lt;</span><span class="n">Observer</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">NonCopyable</span>
        <span class="p">{</span>
            <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ObserveFunc</span><span class="p">)</span> <span class="p">(</span><span class="n">state_t</span><span class="p">,</span> <span class="n">Observer</span><span class="o">*</span><span class="p">);</span>

            <span class="n">ObserveFunc</span> <span class="n">m_observe_func_ptr</span><span class="p">;</span>

        <span class="k">public</span><span class="o">:</span>
            <span class="kt">void</span> <span class="n">observe</span><span class="p">(</span><span class="n">state_t</span> <span class="n">aState</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="o">*</span><span class="n">m_observe_func_ptr</span><span class="p">)(</span><span class="n">aState</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">Observer</span><span class="p">(</span><span class="n">ObserveFunc</span> <span class="n">f</span><span class="p">)</span><span class="o">:</span> <span class="n">m_observe_func_ptr</span><span class="p">(</span><span class="n">f</span><span class="p">){}</span>
        <span class="p">};</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
        <span class="k">class</span> <span class="nc">Adapter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Observer</span>
        <span class="p">{</span>
            <span class="n">T</span> <span class="n">m_observer_impl</span><span class="p">;</span>

        <span class="k">public</span><span class="o">:</span>
            <span class="n">Adapter</span><span class="p">()</span><span class="o">:</span> <span class="n">Observer</span><span class="p">(</span>
                <span class="p">[](</span><span class="n">state_t</span> <span class="n">aState</span><span class="p">,</span> <span class="n">Observer</span><span class="o">*</span> <span class="n">aThis</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">auto</span> <span class="n">self</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Adapter</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">aThis</span><span class="p">);</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">m_observer_impl</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="n">aState</span><span class="p">);</span>
                <span class="p">}){</span><span class="cm">/* empty constructor */</span><span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><em>tasks/left.cpp</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;left.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;color-observer.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;observers/state.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;draw.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;hal.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">obsevers</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">tasks</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">draw</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">draw</span><span class="o">::</span><span class="n">PAGE_0</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nl">LockerObserver</span> <span class="p">:</span> <span class="n">NonCopyable</span> <span class="p">{</span>

    <span class="n">buttons</span><span class="o">::</span><span class="n">Adapter</span><span class="o">&lt;</span><span class="n">ColorObserver</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">LeftLeds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;&gt;</span> <span class="n">o</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">observe</span><span class="p">(</span><span class="n">state</span><span class="o">::</span><span class="n">state_t</span> <span class="n">aState</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">aState</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_active</span><span class="p">:</span>
                <span class="n">str</span><span class="p">(</span><span class="s">&quot;left subscribed  &quot;</span><span class="p">);</span>
                <span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">state</span><span class="o">::</span><span class="nl">left_sleep</span><span class="p">:</span>
                <span class="n">str</span><span class="p">(</span><span class="s">&quot;left unsubscribed&quot;</span><span class="p">);</span>
                <span class="n">buttons</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">state</span><span class="o">::</span><span class="n">Adapter</span><span class="o">&lt;</span><span class="n">LockerObserver</span><span class="o">&gt;</span> <span class="n">observer</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">tasks</span> <span class="p">{</span>
    <span class="k">namespace</span> <span class="n">left</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">str</span><span class="p">(</span><span class="s">&quot;left unsubscribed&quot;</span><span class="p">);</span>
            <span class="n">state</span><span class="o">::</span><span class="n">event</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observer</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–í–æ–∑–º–æ–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞–∫–æ–µ-—Ç–æ –±–æ–ª–µ–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç—É—á–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç –≤—ã–∑–æ–≤–∞ malloc, –Ω–æ –≤ —Ü–µ–ª–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–∏—Ç –≤–ø–æ–ª–Ω–µ —Å—ä–µ–¥–æ–±–Ω—ã–º.</p>
    </div><!-- /.entry-content -->
  </article>
</section>


<div class="body" id="proiot-comments">
  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'mazko';
      var disqus_identifier = 'blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/';
      var disqus_url = 'https://mazko.github.io/blog/posts/2018/03/18/s-dlia-mikrokontrollerov-nabliudatel/';
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//mazko.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</div>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a rel="nofollow" href="http://getpelican.com/">Pelican</a></li>
                            <li><a rel="nofollow" href="http://python.org/">Python.org</a></li>
                            <li><a rel="nofollow" href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://mazko.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a rel="nofollow" href="http://github.com/mazko">github</a></li>
                            <li><a rel="nofollow" href="http://linkedin.com/in/mazko">linkedin</a></li>
                            <li><a rel="nofollow" href="http://stackoverflow.com/users/281102/oleg-mazko">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'mazko';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>