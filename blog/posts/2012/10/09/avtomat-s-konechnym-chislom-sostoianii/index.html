<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <title>–ê–≤—Ç–æ–º–∞—Ç —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π</title>
        <link rel="stylesheet" href="http://proiot.ru/blog/theme/css/main.css" />
        <link href="http://proiot.ru/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó Atom Feed" />

        <script>
            (function(){
                var loc = window.location.href+'';
                if (loc.indexOf('https://')==0){
                    window.location.href = loc.replace('https://','http://');
                }
            })();
        </script>

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a rel="nofollow" href="http://github.com/mazko">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://proiot.ru/">üè† –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –í—Å–µ–≥–æ üöó </a></h1>
                <nav><ul>
                    <li><a href="http://proiot.ru/blog/category/admin/">Admin</a></li>
                    <li><a href="http://proiot.ru/blog/category/electronics/">Electronics</a></li>
                    <li class="active"><a href="http://proiot.ru/blog/category/embedded/">Embedded</a></li>
                    <li><a href="http://proiot.ru/blog/category/iot/">IoT</a></li>
                    <li><a href="http://proiot.ru/blog/category/java/">Java</a></li>
                </ul></nav>
        </header><!-- /#banner -->


<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://proiot.ru/blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/" rel="bookmark"
           title="Permalink to –ê–≤—Ç–æ–º–∞—Ç —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π">–ê–≤—Ç–æ–º–∞—Ç —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-10-09T00:00:00+03:00">
                –í—Ç 09 –æ–∫—Ç—è–±—Ä—è 2012
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://proiot.ru/blog/author/oleg-mazko/">Oleg Mazko</a>
        </address>
<p>In <a href="http://proiot.ru/blog/category/embedded/">Embedded</a>.</p>
<p>tags: <a href="http://proiot.ru/blog/tag/fsm">FSM</a> </p>
</footer><!-- /.post-info -->      <p>–ü—Ä–æ—Å—Ç—ã–º –ø—Ä–∏–º–µ—Ä–æ–º –º–∞—à–∏–Ω—ã —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π (<strong>FSM</strong> - <em>Finite State Machine</em>) –º–æ–∂–µ—Ç –±—ã—Ç—å –ö–∏—Ç–∞–π—Å–∫–∞—è –≥–∏—Ä–ª—è–Ω–¥–∞. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ –æ–Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑ —Å–µ–±—è —á–µ—Ä–Ω—É—é –∫–æ—Ä–æ–±–æ—á–∫—É —Å –∫–Ω–æ–ø–æ—á–∫–æ–π, –¥–≤–∞ –ø—Ä–æ–≤–æ–¥–∞ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è (220 –í), –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–æ–¥–∞ –¥–ª—è —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã—Ö –ª–∞–º–ø–æ—á–µ–∫, –∫–æ—Ç–æ—Ä—ã–º–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –í–Ω—É—Ç—Ä–∏ –∫–æ—Ä–æ–±–æ—á–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è <em>–º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä</em> –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∞—è –æ–±–≤—è–∑–∫–∞. –ú—ã –Ω–µ –±—É–¥–µ–º —É–≥–ª—É–±–ª—è—Ç—å—Å—è –≤ –¥–µ—Ç–∞–ª–∏ —Å—Ö–µ–º–æ—Ç–µ—Ö–Ω–∏–∫–∏ –∞ —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∏–∫–∞—Ö —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑–µ —Ç.–µ. –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —á–∏—Å—Ç–æ–≥–æ <em>ANSI C</em>.</p>
<p>–î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –∫–∞–∫–æ–π-—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–∫–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å / —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ (–≤—ã–±–æ—Ä –ø–∞–ª –Ω–∞ <em>Proteus VSM</em>). –ï—Å—Ç—å –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (PIC16F1823), –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∞–º–ø–æ—á–∫–∞–º–∏ (–≥–∏—Ä–ª—è–Ω–¥–æ–π) –∏ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –∏—Ö —è—Ä–∫–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ —Ü–∏—Ñ—Ä–æ-–∞–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—è –¶–ê–ü (–≤ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–ª—è —ç—Ç–æ–≥–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –®–ò–ú, –¶–ê–ü –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –≤ <em>Proteus VSM</em>). –ë—ã—Å—Ç—Ä–æ –≤–Ω–∏–∫–Ω—É—Ç—å –≤ —Å—É—Ç—å –¥–µ–ª–∞ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ–≤ —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ:</p>
<video width="100%" controls>
  <source src="http://proiot.ru/blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/video.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<p>–ù–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç–æ–≥–æ - –Ω–∞–ø–∏—à–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –≥–∏—Ä–ª—è–Ω–¥—ã —Å <em>–¥–≤—É–º—è</em> —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ - –≤ –ø–µ—Ä–≤–æ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã –ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ –≤—Å–ø—ã—Ö–∏–≤–∞—é—Ç —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, –≤–æ –≤—Ç–æ—Ä–æ–º —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ. –í —Å–∏—Å—Ç–µ–º–µ –¥–≤–∞ —Å–æ–±—ã—Ç–∏—è - –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–æ—á–∫—É (NEXT) –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≥–∏—Ä–ª—è–Ω–¥—ã) —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Ç–∞–π–º–µ—Ä–∞ (TICK). –°–æ–±—ã—Ç–∏–µ NEXT –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</p>
<p><img alt="–î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –°–∫—Ä–∏–Ω—à–æ—Ç" src="http://proiot.ru/blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/State_Diagram.png" style="width:100%; border:1px solid #ddd;"></p>
<h3>–û–ø–µ—Ä–∞—Ç–æ—Ä—ã switch/case</h3>
<p>–ü—Ä–∏–±–µ–≥–Ω—É–≤ –∫ –ø–æ–º–æ—â–∏ —É—Å–ª–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ <code>if</code> / <code>else</code> –∏–ª–∏ <code>switch</code> / <code>case</code> –ø–æ-—Å—Ç–∞—Ä–∏–Ω–∫–µ –∑–∞–¥–∞—á—É —Ä–µ—à–∏–ª–∏ —Ç–∞–∫:</p>
<p><em>FSM/Child/src/main.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;main.h&quot;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">LEFT_TO_RIGHT</span><span class="p">,</span>
    <span class="n">RIGHT_TO_LEFT</span>
<span class="p">}</span> <span class="n">State</span><span class="p">;</span>

<span class="cm">/* Global variable to hold current state */</span>

<span class="k">static</span> <span class="n">State</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>

<span class="cm">/* Event handlers implementations */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextLeftLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextRightLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">LEFT_TO_RIGHT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">initHardware</span><span class="p">();</span> <span class="c1">// in main.h</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

        <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
            <span class="n">NEXT</span><span class="p">,</span>
            <span class="n">TICK</span>
        <span class="p">}</span> <span class="n">Event</span><span class="p">;</span>

        <span class="cm">/* –°–æ–±—ã—Ç–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é */</span>

        <span class="n">Event</span> <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">TICK</span><span class="p">;</span>

        <span class="cm">/* –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É, —Å–æ–±—ã—Ç–∏–µ NEXT */</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isNextButtonPressed</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">NEXT</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// Fire NEXT event</span>
            <span class="p">}</span> 
        <span class="p">}</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">currentState</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">LEFT_TO_RIGHT</span> <span class="p">:</span> 
                <span class="k">switch</span> <span class="p">(</span><span class="n">eventToFire</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="nl">TICK</span><span class="p">:</span>
                        <span class="n">onLeftToRightTickImpl</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span> <span class="c1">// TICK</span>
                    <span class="k">case</span> <span class="nl">NEXT</span><span class="p">:</span>
                        <span class="n">onLeftToRightNextImpl</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span> <span class="c1">// NEXT</span>

                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// LEFT_TO_RIGHT</span>
            <span class="k">case</span> <span class="nl">RIGHT_TO_LEFT</span> <span class="p">:</span> 
                <span class="k">switch</span> <span class="p">(</span><span class="n">eventToFire</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="nl">TICK</span><span class="p">:</span>
                        <span class="n">onRightToLeftTickImpl</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span> <span class="c1">// TICK</span>
                    <span class="k">case</span> <span class="nl">NEXT</span><span class="p">:</span>
                        <span class="n">onRightToLeftNextImpl</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span> <span class="c1">// NEXT</span>

                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// RIGHT_TO_LEFT</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª <strong>main.h</strong>, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–ª–∞–≥–∞–µ—Ç—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º. –î–ª—è —Å–±–æ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä HI-TECH PICC:</p>
<div class="highlight"><pre><span></span>/usr/hitech/picc/9.83/bin/PICC --opt<span class="o">=</span>all --chip<span class="o">=</span>16F1823 --ASMLIST main.c
</pre></div>


<p>–ß—Ç–æ –º—ã –º–æ–∂–µ–º —Å–∫–∞–∑–∞—Ç—å –æ–± —ç—Ç–æ–º —Ä–µ—à–µ–Ω–∏–∏, –∫—Ä–æ–º–µ —Ç–æ–≥–æ, —á—Ç–æ —Ç–∞–º –º–Ω–æ–≥–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–ª–æ–≤ <code>switch</code> –∏ <code>case</code> ?</p>
<ul>
<li>
<p>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–µ–±–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–æ–¥–∞ —Å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º <code>switch</code> / <code>case</code>. –¢–∞–∫–æ–π –∫–æ–¥ —Å–ª–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å. –í —Å–∞–º–∏—Ö <code>switch</code> / <code>case</code> –∏–ª–∏ <code>if</code> / <code>else</code> –Ω–µ—Ç –Ω–∏—á–µ–≥–æ –ø–ª–æ—Ö–æ–≥–æ - –≤ –∫–æ–Ω—Ü–µ-–∫–æ–Ω—Ü–æ–≤ —ç—Ç–æ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ <strong>–°</strong>. –ù–æ –∫–æ–≥–¥–∞ –∏—Ö –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, —Å —ç—Ç–∏–º –Ω—É–∂–Ω–æ –±–æ—Ä–æ—Ç—å—Å—è.</p>
</li>
<li>
<p>H–µ—Ç —É–¥–∞—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É –ª–æ–≥–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–∞—à–∏–Ω–æ–π —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö.</p>
</li>
</ul>
<h3>–¢–∞–±–ª–∏—á–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞</h3>
<p>–í—Ç–æ—Ä–æ–π —Å–ø–æ—Å–æ–± —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ —Å–æ—Å—Ç–æ–∏—Ç –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:</p>
<p><em>FSM/Table/Simple/src/main.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;main.h&quot;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">LEFT_TO_RIGHT</span><span class="p">,</span>
    <span class="n">RIGHT_TO_LEFT</span>
<span class="p">}</span> <span class="n">State</span><span class="p">;</span>

<span class="cm">/* Global variable to hold current state */</span>

<span class="k">static</span> <span class="n">State</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>

<span class="cm">/* Event handlers implementations */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextLeftLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextRightLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">LEFT_TO_RIGHT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">initHardware</span><span class="p">();</span> <span class="c1">// in main.h</span>

    <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
        <span class="n">NEXT</span><span class="p">,</span>
        <span class="n">TICK</span>
    <span class="p">}</span> <span class="n">Event</span><span class="p">;</span>

    <span class="k">typedef</span> <span class="k">struct</span> <span class="n">_Transition</span> <span class="p">{</span>
        <span class="n">State</span> <span class="n">state</span><span class="p">;</span>
        <span class="n">Event</span> <span class="n">event</span><span class="p">;</span>
        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">EventFunc</span><span class="p">)();</span>
    <span class="p">}</span> <span class="n">Transition</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">Transition</span> <span class="n">transitionTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">LEFT_TO_RIGHT</span><span class="p">,</span> <span class="n">TICK</span><span class="p">,</span> <span class="n">onLeftToRightTickImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">LEFT_TO_RIGHT</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">onLeftToRightNextImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">RIGHT_TO_LEFT</span><span class="p">,</span> <span class="n">TICK</span><span class="p">,</span> <span class="n">onRightToLeftTickImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">RIGHT_TO_LEFT</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">onRightToLeftNextImpl</span><span class="p">}</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

        <span class="cm">/* –°–æ–±—ã—Ç–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é */</span>

        <span class="n">Event</span> <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">TICK</span><span class="p">;</span>

        <span class="cm">/* –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É, —Å–æ–±—ã—Ç–∏–µ NEXT */</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isNextButtonPressed</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">NEXT</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// Fire NEXT event</span>
            <span class="p">}</span> 
        <span class="p">}</span>

        <span class="cm">/* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è */</span>

        <span class="kt">int</span> <span class="n">elementsCount</span> <span class="o">=</span> 
            <span class="k">sizeof</span><span class="p">(</span><span class="n">transitionTable</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">transitionTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">elementsCount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Transition</span> <span class="n">transition</span> <span class="o">=</span> <span class="n">transitionTable</span><span class="p">[</span><span class="n">elementsCount</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">transition</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">currentState</span> <span class="o">&amp;&amp;</span> 
                <span class="n">transition</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">eventToFire</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">transition</span><span class="p">.</span><span class="n">EventFunc</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// –§—É–Ω–∫—Ü–∏—è EventFunc –Ω–∞–π–¥–µ–Ω–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º –¥–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º:</p>
<ul>
<li>
<p>–¢–∞–±–ª–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ - –∫–∞–∫ –º–∏–Ω–∏–º—É–º –¥–æ–±–∞–≤–∏–ª—Å—è —Ü–∏–∫–ª <code>while</code>. –î–ª—è –æ–±—Ö–æ–¥–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∞ –∏–¥–∏–æ–º–∞ –ö–û–õ–ò–ß–ï–°–¢–í–û –≠–õ–ï–ú–ï–ù–¢–û–í –ú–ê–°–°–ò–í–ê –ö–ê–ö –†–ï–ó–£–õ–¨–¢–ê–¢ –î–ï–õ–ï–ù–ò–Ø, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å—ã–≤–∞–ª–∞—Å—å <a href="http://proiot.ru/blog/posts/2012/10/08/idiomy-v-ansi-c/">—Ä–∞–Ω–µ–µ</a>.</p>
</li>
<li>
<p>B—Å—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ. –í—Å—ë –≤–∏–¥–Ω–æ, –∫–∞–∫ –Ω–∞ –ª–∞–¥–æ–Ω–∏. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è / –≤—Å–ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫ –≤—Å—ë —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.</p>
</li>
<li>
<p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–∞—à–∏–Ω–æ–π —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π.  –î–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –µ—â—ë –æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –ª–∞–º–ø–æ—á–∫–∏ <strong>–ø–ª–∞–≤–Ω–æ</strong> –º–µ–Ω—è—é—Ç —è—Ä–∫–æ—Å—Ç—å:</p>
</li>
</ul>
<p><em>FSM/Table/Scale/src/main.c</em></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;main.h&quot;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">LEFT_TO_RIGHT</span><span class="p">,</span>
    <span class="n">RIGHT_TO_LEFT</span><span class="p">,</span>

    <span class="cm">/* Add brightness algoritms States */</span>

    <span class="n">RIGHT_LEFT_TO_BRIGHT</span>
<span class="p">}</span> <span class="n">State</span><span class="p">;</span>

<span class="cm">/* Global variable to hold current state */</span>

<span class="k">static</span> <span class="n">State</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>

<span class="cm">/* Event handlers implementations */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextLeftLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onLeftToRightNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_TO_LEFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextRightLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="cm">/* LEFT_TO_RIGHT ==&gt; RIGHT_LEFT_TO_BRIGHT */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">RIGHT_LEFT_TO_BRIGHT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add brightness handlers */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftBrigtTickImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nextRightBrightLed</span><span class="p">();</span> <span class="c1">// in main.h</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">onRightToLeftBrigtNextImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetLeds</span><span class="p">();</span> <span class="c1">// in main.h</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">LEFT_TO_RIGHT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">initHardware</span><span class="p">();</span> <span class="c1">// in main.h</span>

    <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
        <span class="n">NEXT</span><span class="p">,</span>
        <span class="n">TICK</span>
    <span class="p">}</span> <span class="n">Event</span><span class="p">;</span>

    <span class="k">typedef</span> <span class="k">struct</span> <span class="n">_Transition</span> <span class="p">{</span>
        <span class="n">State</span> <span class="n">state</span><span class="p">;</span>
        <span class="n">Event</span> <span class="n">event</span><span class="p">;</span>
        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">EventFunc</span><span class="p">)();</span>
    <span class="p">}</span> <span class="n">Transition</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">Transition</span> <span class="n">transitionTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">LEFT_TO_RIGHT</span><span class="p">,</span> <span class="n">TICK</span><span class="p">,</span> <span class="n">onLeftToRightTickImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">LEFT_TO_RIGHT</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">onLeftToRightNextImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">RIGHT_TO_LEFT</span><span class="p">,</span> <span class="n">TICK</span><span class="p">,</span> <span class="n">onRightToLeftTickImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">RIGHT_TO_LEFT</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">onRightToLeftNextImpl</span><span class="p">},</span>

        <span class="cm">/* Add brightness algoritms transitions */</span>

        <span class="p">{</span><span class="n">RIGHT_LEFT_TO_BRIGHT</span><span class="p">,</span> <span class="n">TICK</span><span class="p">,</span> <span class="n">onRightToLeftBrigtTickImpl</span><span class="p">},</span>
        <span class="p">{</span><span class="n">RIGHT_LEFT_TO_BRIGHT</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">onRightToLeftBrigtNextImpl</span><span class="p">}</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

        <span class="cm">/* –°–æ–±—ã—Ç–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é */</span>

        <span class="n">Event</span> <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">TICK</span><span class="p">;</span>

        <span class="cm">/* –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É, —Å–æ–±—ã—Ç–∏–µ NEXT */</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isNextButtonPressed</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">eventToFire</span> <span class="o">=</span> <span class="n">NEXT</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// Fire NEXT event</span>
            <span class="p">}</span> 
        <span class="p">}</span>

        <span class="cm">/* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è */</span>

        <span class="kt">int</span> <span class="n">elementsCount</span> <span class="o">=</span> 
            <span class="k">sizeof</span><span class="p">(</span><span class="n">transitionTable</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">transitionTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">elementsCount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Transition</span> <span class="n">transition</span> <span class="o">=</span> <span class="n">transitionTable</span><span class="p">[</span><span class="n">elementsCount</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">transition</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">currentState</span> <span class="o">&amp;&amp;</span> 
                <span class="n">transition</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">eventToFire</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">transition</span><span class="p">.</span><span class="n">EventFunc</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span> <span class="c1">// –§—É–Ω–∫—Ü–∏—è EventFunc –Ω–∞–π–¥–µ–Ω–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>–ù–µ—Å–ª–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –∫–æ–¥ –≤ —Å—É–ø–µ—Ä—Ü–∏–∫–ª–µ <code>for(;;)</code> –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç.–µ. —Ä–µ—à–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –ª—É—á—à–µ–π <em>—Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å—é</em> –∫–æ–¥–∞.</p>
<p>–î–∞–ª–µ–µ –∏–ª–∏ <a href="http://proiot.ru/blog/posts/2017/02/05/picsimjs-soprogrammy-i-prosteishaia-mnogozadachnost/">—Å–æ–ø—Ä–æ–≥—Ä–∞–º–º—ã</a> –∏–ª–∏ <a href="http://proiot.ru/blog/posts/2017/05/25/zhizn-posle-rtos-model-aktorov-qpc-uml/">Quantum Leaps QP –∏ UML statecharts</a>.</p>
<p>–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ <a href="http://proiot.ru/blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/FSM.zip">—Ç—É—Ç</a>.</p>
    </div><!-- /.entry-content -->
  </article>
</section>

<div class="body" style="margin-bottom: 2em">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- proiot-index -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6247427373315098"
     data-ad-slot="2711782349"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<div class="body" id="proiot-comments">
  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'mazko';
      var disqus_identifier = 'blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/';
      var disqus_url = 'http://proiot.ru/blog/posts/2012/10/09/avtomat-s-konechnym-chislom-sostoianii/';
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//mazko.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</div>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a rel="nofollow" href="http://getpelican.com/">Pelican</a></li>
                            <li><a rel="nofollow" href="http://python.org/">Python.org</a></li>
                            <li><a rel="nofollow" href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://proiot.ru/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a rel="nofollow" href="http://github.com/mazko">github</a></li>
                            <li><a rel="nofollow" href="http://linkedin.com/in/mazko">linkedin</a></li>
                            <li><a rel="nofollow" href="http://stackoverflow.com/users/281102/oleg-mazko">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'mazko';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>